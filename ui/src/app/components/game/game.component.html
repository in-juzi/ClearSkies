<div class="game-container">
  <header class="game-header">
    <div class="header-left">
      <h1>ClearSkies</h1>
    </div>
    <div class="header-right">
      @if (currentUser()) {
        <span class="username">{{ currentUser()!.username }}</span>
        <button class="quest-link" (click)="openQuestJournal()">Quests</button>
        <button class="manual-link" (click)="openManual()">Manual</button>
        <button class="logout-btn" (click)="onLogout()">Logout</button>
      }
    </div>
  </header>

  <!-- Manual Dialog -->
  @if (manualDialogService.isOpen()) {
    <app-manual [dialogMode]="true" />
  }

  <!-- Notification Display -->
  <app-notification-display />

  <main class="game-main">
    @if (currentPlayer()) {
      <div class="game-layout">
        <!-- Left Sidebar: Inventory -->
        <aside class="left-sidebar" [class.collapsed]="leftSidebarCollapsed()">
          <!-- Expand Button (when collapsed) -->
          @if (leftSidebarCollapsed()) {
            <button
              class="expand-toggle left-toggle"
              (click)="toggleLeftSidebar()"
              [attr.aria-label]="'Expand inventory'">
              <span class="material-symbols-outlined">left_panel_open</span>
            </button>
          }

          @if (!leftSidebarCollapsed()) {
            <!-- Tab Navigation -->
            <div class="sidebar-nav">
              <button
                class="nav-tab"
                [class.active]="leftSidebarTab() === 'inventory'"
                (click)="leftSidebarTab.set('inventory')">
                Inventory
              </button>
              <button
                class="nav-tab"
                [class.active]="leftSidebarTab() === 'quests'"
                (click)="leftSidebarTab.set('quests')">
                Quests
              </button>
              <button
                class="nav-tab"
                [class.active]="leftSidebarTab() === 'housing'"
                (click)="leftSidebarTab.set('housing')">
                Housing
              </button>

              <!-- Collapse Button (inside nav when expanded) -->
              <button
                class="sidebar-collapse-btn"
                (click)="toggleLeftSidebar()"
                title="Collapse sidebar">
                <span class="material-symbols-outlined">left_panel_close</span>
              </button>
            </div>

            <!-- Tab Content -->
            <div class="sidebar-content">
              @if (leftSidebarTab() === 'inventory') {
                <app-inventory></app-inventory>
              }
              @if (leftSidebarTab() === 'quests') {
                <app-quest-tracker></app-quest-tracker>
              }
              @if (leftSidebarTab() === 'housing') {
                <app-housing></app-housing>
              }
            </div>
          }
        </aside>

        <!-- Center: Main Game Area -->
        <section class="center-content">
          <app-location></app-location>

          <!-- Chat Component (Bottom of Center Content) -->
          @if (currentPlayer()) {
            <app-chat></app-chat>
          }
        </section>

        <!-- Right Sidebar: Character/Skills/Attributes/Status -->
        <aside class="right-sidebar" [class.collapsed]="rightSidebarCollapsed()">
          <!-- Expand Button (when collapsed) -->
          @if (rightSidebarCollapsed()) {
            <button
              class="expand-toggle right-toggle"
              (click)="toggleRightSidebar()"
              [attr.aria-label]="'Expand character panel'">
              <span class="material-symbols-outlined">right_panel_open</span>
            </button>
          }

          @if (!rightSidebarCollapsed()) {
            <!-- World Map Minimap -->
            <div class="minimap-wrapper">
              <app-world-map mode="minimap" (travelRequested)="handleTravelRequest($event)"></app-world-map>
              <button class="expand-map-btn" (click)="openMapDialog()" title="Open full map">
                <span class="material-symbols-outlined">map</span>
              </button>
            </div>

            <!-- Tab Navigation -->
            <div class="sidebar-nav">
              <!-- Collapse Button (inside nav when expanded) -->
              <button
                class="sidebar-collapse-btn"
                (click)="toggleRightSidebar()"
                title="Collapse sidebar">
                <span class="material-symbols-outlined">right_panel_close</span>
              </button>

              <button
                class="nav-tab"
                [class.active]="rightSidebarTab() === 'character'"
                (click)="rightSidebarTab.set('character')">
                Character
              </button>
              <button
                class="nav-tab"
                [class.active]="rightSidebarTab() === 'equipment'"
                (click)="rightSidebarTab.set('equipment')">
                Equipment
              </button>
              <button
                class="nav-tab"
                [class.active]="rightSidebarTab() === 'skills'"
                (click)="rightSidebarTab.set('skills')">
                Skills
              </button>
              <button
                class="nav-tab"
                [class.active]="rightSidebarTab() === 'attributes'"
                (click)="rightSidebarTab.set('attributes')">
                Attributes
              </button>
              <button
                class="nav-tab"
                [class.active]="rightSidebarTab() === 'status'"
                (click)="rightSidebarTab.set('status')">
                Status
              </button>
            </div>

            <!-- Tab Content -->
            <div class="sidebar-content">
            <!-- Character Tab -->
            @if (rightSidebarTab() === 'character') {
              <div class="panel">
                <div class="character-summary">
                  <h3>{{ currentUser()?.username }}</h3>

                  <!-- Health and Mana Displays -->
                  <div class="health-mana-container">
                    <div class="stat-display">
                      <div class="stat-label" [title]="getHPTooltip()">Health ⓘ</div>
                      <div class="bar-container">
                        <div class="bar health-bar"
                             [style.width.%]="getHPPercent()">
                        </div>
                        <div class="bar-text">{{ currentPlayer()!.stats.health.current }} / {{ getMaxHP() }}</div>
                      </div>
                    </div>
                    <div class="stat-display">
                      <div class="stat-label" [title]="getMPTooltip()">Mana ⓘ</div>
                      <div class="bar-container">
                        <div class="bar mana-bar"
                             [style.width.%]="getMPPercent()">
                        </div>
                        <div class="bar-text">{{ currentPlayer()!.stats.mana.current }} / {{ getMaxMP() }}</div>
                      </div>
                    </div>
                  </div>

                  <div class="total-levels">
                    <div class="total-level-item">
                      <span class="total-level-label">Total Skill Level:</span>
                      <span class="total-level-value">{{ getTotalSkillLevel() }}</span>
                    </div>
                    <div class="total-level-item">
                      <span class="total-level-label">Total Attribute Level:</span>
                      <span class="total-level-value">{{ getTotalAttributeLevel() }}</span>
                    </div>
                  </div>
                </div>
                <app-skills></app-skills>
                <app-attributes></app-attributes>
              </div>
            }

            <!-- Equipment Tab -->
            @if (rightSidebarTab() === 'equipment') {
              <app-equipment></app-equipment>
            }

            <!-- Skills Tab -->
            @if (rightSidebarTab() === 'skills') {
              <app-skills></app-skills>
            }

            <!-- Attributes Tab -->
            @if (rightSidebarTab() === 'attributes') {
              <app-attributes></app-attributes>
            }

            <!-- Status Tab -->
            @if (rightSidebarTab() === 'status') {
              <app-character-status></app-character-status>
            }
            </div>
          }
        </aside>
      </div>
    } @else {
      <div class="loading">Loading player data...</div>
    }
  </main>

  <!-- Bank Modal (rendered when bank is open) -->
  <app-bank></app-bank>

  <!-- World Map Dialog (fullscreen) -->
  @if (mapDialogOpen()) {
    <div class="map-dialog-overlay" (click)="closeMapDialog()">
      <div class="map-dialog-content" (click)="$event.stopPropagation()">
        <div class="dialog-header">
          <h2>World Map</h2>
          <button class="close-btn" (click)="closeMapDialog()" title="Close map">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <app-world-map
          mode="fullscreen"
          (travelRequested)="handleTravelRequest($event)"
        ></app-world-map>
      </div>
    </div>
  }

  <!-- Quest Journal Dialog (fullscreen) -->
  @if (questJournalOpen()) {
    <div class="quest-journal-overlay" (click)="closeQuestJournal()">
      <div class="quest-journal-content" (click)="$event.stopPropagation()">
        <div class="dialog-header">
          <button class="close-btn" (click)="closeQuestJournal()" title="Close quest journal">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <app-quest-journal></app-quest-journal>
      </div>
    </div>
  }
</div>
