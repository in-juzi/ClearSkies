<div class="game-container">
  <header class="game-header">
    <div class="header-left">
      <h1>ClearSkies</h1>
    </div>
    <div class="header-right">
      @if (currentUser()) {
        <span class="username">{{ currentUser()!.username }}</span>
        <button class="manual-link" (click)="openManual()">Manual</button>
        <button class="logout-btn" (click)="onLogout()">Logout</button>
      }
    </div>
  </header>

  <!-- Manual Dialog -->
  @if (manualDialogService.isOpen()) {
    <app-manual [dialogMode]="true" />
  }

  <main class="game-main">
    @if (currentPlayer()) {
      <div class="game-layout">
        <!-- Left Sidebar: Inventory -->
        <aside class="left-sidebar">
          <!-- Tab Navigation -->
          <div class="sidebar-nav">
            <button
              class="nav-tab"
              [class.active]="leftSidebarTab() === 'inventory'"
              (click)="leftSidebarTab.set('inventory')">
              Inventory
            </button>
          </div>

          <!-- Tab Content -->
          <div class="sidebar-content">
            @if (leftSidebarTab() === 'inventory') {
              <app-inventory></app-inventory>
            }
          </div>
        </aside>

        <!-- Center: Main Game Area -->
        <section class="center-content">
          <app-location></app-location>
        </section>

        <!-- Right Sidebar: Character/Skills/Attributes/Status -->
        <aside class="right-sidebar">
          <!-- Tab Navigation -->
          <div class="sidebar-nav">
            <button
              class="nav-tab"
              [class.active]="rightSidebarTab() === 'character'"
              (click)="rightSidebarTab.set('character')">
              Character
            </button>
            <button
              class="nav-tab"
              [class.active]="rightSidebarTab() === 'equipment'"
              (click)="rightSidebarTab.set('equipment')">
              Equipment
            </button>
            <button
              class="nav-tab"
              [class.active]="rightSidebarTab() === 'skills'"
              (click)="rightSidebarTab.set('skills')">
              Skills
            </button>
            <button
              class="nav-tab"
              [class.active]="rightSidebarTab() === 'attributes'"
              (click)="rightSidebarTab.set('attributes')">
              Attributes
            </button>
            <button
              class="nav-tab"
              [class.active]="rightSidebarTab() === 'status'"
              (click)="rightSidebarTab.set('status')">
              Status
            </button>
          </div>

          <!-- Tab Content -->
          <div class="sidebar-content">
            <!-- Character Tab -->
            @if (rightSidebarTab() === 'character') {
              <div class="panel">
                <div class="character-info">
                  <div class="level-badge">
                    Level {{ currentPlayer()!.level }}
                  </div>
                  <div class="experience-bar">
                    <div class="bar-label">Experience</div>
                    <div class="bar-container">
                      <div class="bar exp-bar" [style.width.%]="(currentPlayer()!.experience % 100)">
                      </div>
                      <span class="bar-text">{{ currentPlayer()!.experience }} XP</span>
                    </div>
                  </div>
                </div>

                <div class="vital-stats">
                  <div class="stat-bar">
                    <div class="bar-label">Health</div>
                    <div class="bar-container">
                      <div class="bar health-bar"
                           [style.width.%]="(currentPlayer()!.stats.health.current / currentPlayer()!.stats.health.max) * 100">
                      </div>
                      <span class="bar-text">
                        {{ currentPlayer()!.stats.health.current }} / {{ currentPlayer()!.stats.health.max }}
                      </span>
                    </div>
                  </div>

                  <div class="stat-bar">
                    <div class="bar-label">Mana</div>
                    <div class="bar-container">
                      <div class="bar mana-bar"
                           [style.width.%]="(currentPlayer()!.stats.mana.current / currentPlayer()!.stats.mana.max) * 100">
                      </div>
                      <span class="bar-text">
                        {{ currentPlayer()!.stats.mana.current }} / {{ currentPlayer()!.stats.mana.max }}
                      </span>
                    </div>
                  </div>
                </div>

                <div class="attributes-summary">
                  <h4>Attributes</h4>
                  @if (attributes()) {
                    <div class="attribute-list">
                      @for (attrName of getAttributeNames(); track attrName) {
                        <div class="attribute-item">
                          <span class="attribute-label">{{ capitalize(attrName) }}</span>
                          <span class="attribute-value">Lv {{ attributes()![attrName].level }}</span>
                        </div>
                      }
                    </div>
                  } @else {
                    <div class="loading-attributes">Loading...</div>
                  }
                </div>
              </div>
            }

            <!-- Equipment Tab -->
            @if (rightSidebarTab() === 'equipment') {
              <app-equipment></app-equipment>
            }

            <!-- Skills Tab -->
            @if (rightSidebarTab() === 'skills') {
              <app-skills></app-skills>
            }

            <!-- Attributes Tab -->
            @if (rightSidebarTab() === 'attributes') {
              <app-attributes></app-attributes>
            }

            <!-- Status Tab -->
            @if (rightSidebarTab() === 'status') {
              <app-character-status></app-character-status>
            }
          </div>
        </aside>
      </div>
    } @else {
      <div class="loading">Loading player data...</div>
    }
  </main>

  <!-- Chat Component (Fixed Position Overlay) -->
  @if (currentPlayer()) {
    <app-chat></app-chat>
  }
</div>
