<div class="equipment-container">
  <h2 class="equipment-title">Equipment</h2>

  <div class="equipment-grid">
    @for (slot of slotConfigs; track slot.name) {
      <div
        class="equipment-slot"
        [class.drag-over]="isSlotDraggedOver(slot.name)"
        [class.occupied]="getItemInSlot(slot.name)"
        [style.grid-row]="slot.position.row"
        [style.grid-column]="slot.position.col"
        (dragover)="onDragOver($event, slot.name)"
        (dragleave)="onDragLeave()"
        (drop)="onDrop($event, slot.name)"
        (contextmenu)="onSlotContextMenu($event, slot.name)"
        [title]="slot.label">

        <!-- Empty slot -->
        @if (!getItemInSlot(slot.name)) {
          <div class="slot-empty">
            <img [src]="slot.icon" [alt]="slot.label" class="slot-icon" />
            <span class="slot-label">{{ slot.label }}</span>
          </div>
        }

        <!-- Equipped item -->
        @if (getItemInSlot(slot.name); as item) {
          <div
            class="slot-item"
            [class]="getRarityClass(item.definition.rarity)"
            (click)="onItemClick(slot.name)">
            @if (item.definition.icon) {
              <app-icon [icon]="item.definition.icon" [autoSize]="true" class="item-icon"></app-icon>
            } @else {
              <img [src]="slot.icon" [alt]="slot.label" class="item-icon" />
            }
            <div class="item-info">
              <div class="item-name">{{ item.definition.name }}</div>
            </div>
            <div class="item-rarity-badge">{{ item.definition.rarity }}</div>
          </div>
        }
      </div>
    }
  </div>

  <div class="equipment-help">
    <p><strong>Drag & Drop</strong> equipment from inventory to equip</p>
    <p><strong>Right-click</strong> equipped items to unequip</p>
    <p><strong>Left-click</strong> equipped items to view details</p>
  </div>

  <!-- Equipment Summary -->
  <div class="equipment-summary">
    <h3 class="summary-title">Equipment Summary</h3>

    @if (equipmentSummary().itemCount === 0) {
      <div class="summary-empty">
        <p>No items equipped</p>
      </div>
    } @else {
      <div class="summary-content">
        <!-- Offensive Stats -->
        @if (equipmentSummary().weaponCount > 0) {
          <div class="stat-group offensive">
            <h4 class="stat-group-title">Offensive</h4>
            <div class="stat-items">
              @if (equipmentSummary().totalDamage.length > 0) {
                <div class="stat-item">
                  <span class="stat-label">Damage:</span>
                  <span class="stat-value">{{ equipmentSummary().totalDamage.join(', ') }}</span>
                </div>
              }
              @if (equipmentSummary().averageAttackSpeed > 0) {
                <div class="stat-item">
                  <span class="stat-label">Attack Speed:</span>
                  <span class="stat-value">{{ equipmentSummary().averageAttackSpeed.toFixed(2) }}s</span>
                </div>
              }
              @if (equipmentSummary().totalCritChance > 0) {
                <div class="stat-item">
                  <span class="stat-label">Crit Chance:</span>
                  <span class="stat-value">{{ (equipmentSummary().totalCritChance * 100).toFixed(1) }}%</span>
                </div>
              }
            </div>
          </div>
        }

        <!-- Defensive Stats -->
        @if (equipmentSummary().armorCount > 0 || equipmentSummary().totalEvasion !== 0 || equipmentSummary().totalBlockChance > 0) {
          <div class="stat-group defensive">
            <h4 class="stat-group-title">Defensive</h4>
            <div class="stat-items">
              @if (equipmentSummary().totalArmor > 0) {
                <div class="stat-item">
                  <span class="stat-label">Armor:</span>
                  <span class="stat-value">{{ equipmentSummary().totalArmor }}</span>
                </div>
              }
              @if (equipmentSummary().totalEvasion !== 0) {
                <div class="stat-item">
                  <span class="stat-label">Evasion:</span>
                  <span class="stat-value" [class.negative]="equipmentSummary().totalEvasion < 0">
                    {{ equipmentSummary().totalEvasion > 0 ? '+' : '' }}{{ equipmentSummary().totalEvasion }}
                  </span>
                </div>
              }
              @if (equipmentSummary().totalBlockChance > 0) {
                <div class="stat-item">
                  <span class="stat-label">Block Chance:</span>
                  <span class="stat-value">{{ (equipmentSummary().totalBlockChance * 100).toFixed(1) }}%</span>
                </div>
              }
            </div>
          </div>
        }
      </div>
    }
  </div>

  <!-- Item Details Panel (Shared Component) -->
  <app-item-details-panel
    *ngIf="selectedItem"
    [item]="selectedItem"
    [showActions]="true"
    [showDropControls]="false"
    (close)="closeItemDetails()"
    (equipItem)="equipItem($event)"
    (unequipItem)="unequipItem($event)"
    (useItem)="useItem($event)"
    (removeItem)="removeItem($event.instanceId)"
    (removeAllItems)="removeAllItems($event)">
  </app-item-details-panel>
</div>
