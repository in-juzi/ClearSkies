@if (activeActivity()?.activityId && activityProgress()) {
  <button (click)="cancelActivity()" class="btn-back">‚Üê Back to Activities</button>

  <!-- Active Activity State -->
  <div class="activity-view">
    <h2>{{ activeActivityName() || 'Activity in Progress' }}</h2>
    <div class="activity-progress">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="getActivityProgressPercent()"></div>
      </div>
      <p>
        Time remaining: {{ formatTime(activityProgress()?.remainingTime || 0) }}
      </p>
    </div>

    <!-- Skill Training Display -->
    @if (activeSkill()) {
      <div class="skill-training">
        <div class="skill-training-header">
          <img [src]="getSkillIcon(activeSkill()!.name)" [alt]="getSkillDisplayName(activeSkill()!.name)"
            class="skill-icon" loading="lazy">
          <div class="skill-title-section">
            <h3>{{ getSkillDisplayName(activeSkill()!.name) }}</h3>
            <span class="training-label">Training</span>
          </div>
        </div>
        <div class="skill-info">
          <div class="skill-header">
            <span class="skill-level">Level {{ activeSkill()!.skill.level }}</span>
            <span class="skill-xp">{{ getExperienceToNext(activeSkill()!.skill.experience) }} XP to level</span>
          </div>
          <div class="xp-bar">
            <div class="xp-fill" [style.width.%]="activeSkill()!.skill.progress"></div>
          </div>
        </div>
      </div>
    }

    <!-- Activity Log -->
    @if (activityLog.length > 0) {
      <app-activity-log
        [entries]="activityLog"
        [maxEntries]="10"
        [showTimestamp]="true"
        [title]="'Recent Completions'">
      </app-activity-log>
    }

    <!-- Rewards Display -->
    @if (lastRewards) {
      <div class="rewards-display">
        <h3>Rewards Received!</h3>
        <div class="reward-items">
          @if (lastRewards.gold > 0) {
            <div class="reward-item">
              <span class="reward-icon">üí∞</span>
              <span>{{ lastRewards.gold }} Gold</span>
            </div>
          }
          @for (item of lastRewards.items; track item.instanceId) {
            <div class="reward-item">
              <span class="reward-icon">üì¶</span>
              <span>{{ item.itemId }} x{{ item.quantity }}</span>
            </div>
          }
          @for (exp of lastRewards.experience | keyvalue; track exp.key) {
            <div class="reward-item">
              <span class="reward-icon">‚≠ê</span>
              <span>{{ exp.key }}: +{{ exp.value.skill?.leveledUp ? exp.value.skill.newLevel : exp.value.level }}
                XP</span>
              @if (exp.value.leveledUp || exp.value.skill?.leveledUp) {
                <span class="level-up">LEVEL UP!</span>
              }
            </div>
          }
        </div>
      </div>
    }
  </div>
}
