@if (activeActivity()?.activityId && activityProgress()) {
  <button (click)="cancelActivity()" class="btn-back">‚Üê Back to Activities</button>

  <!-- Active Activity State -->
  <div class="activity-view">
    <h2>{{ activeActivityName() || 'Activity in Progress' }}</h2>
    <div class="activity-progress">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="getActivityProgressPercent()"></div>
      </div>
      <p>
        Time remaining: {{ formatTime(activityProgress()?.remainingTime || 0) }}
      </p>
    </div>

    <!-- Skill Training Display -->
    @if (activeSkill()) {
      <div class="skill-training">
        <div class="skill-training-header">
          <img [src]="getSkillIcon(activeSkill()!.name)" [alt]="getSkillDisplayName(activeSkill()!.name)"
            class="skill-icon" loading="lazy">
          <div class="skill-title-section">
            <h3>{{ getSkillDisplayName(activeSkill()!.name) }}</h3>
            <span class="training-label">Training</span>
          </div>
        </div>
        <div class="skill-info">
          <div class="skill-header">
            <span class="skill-level">Level {{ activeSkill()!.skill.level }}</span>
            <span class="skill-xp">{{ getExperienceToNext(activeSkill()!.skill.experience) }} XP to level</span>
          </div>
          <div class="xp-bar">
            <div class="xp-fill" [style.width.%]="activeSkill()!.skill.progress"></div>
          </div>
        </div>
      </div>
    }

    <!-- Activity Log -->
    @if (activityLog.length > 0) {
      <div class="activity-log">
        <h3>Recent Completions</h3>
        <div class="log-entries">
          @for (entry of activityLog; track entry.timestamp) {
            <div class="log-entry">
              <div class="log-timestamp">{{ entry.timestamp | date:'HH:mm:ss' }}</div>
              <div class="log-content">
                <div class="log-rewards">
                  @if (entry.rewards.gold > 0) {
                    <span class="reward-mini gold">üí∞ {{ entry.rewards.gold }}</span>
                  }
                  @for (item of entry.rewards.items; track item.instanceId) {
                    <app-item-mini [item]="item"></app-item-mini>
                  }
                  @for (exp of entry.rewards.experience | keyvalue; track exp.key) {
                    <app-xp-mini [skillName]="exp.key" [xp]="exp.value.experience"
                      [rawXp]="entry.rewards.rawExperience?.[exp.key]" [showIcon]="true" [showSkillName]="true"
                      [showScaling]="true">
                    </app-xp-mini>
                    @if (exp.value.leveledUp) {
                      <span class="level-up-mini">‚Üë</span>
                    }
                  }
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    }

    <!-- Rewards Display -->
    @if (lastRewards) {
      <div class="rewards-display">
        <h3>Rewards Received!</h3>
        <div class="reward-items">
          @if (lastRewards.gold > 0) {
            <div class="reward-item">
              <span class="reward-icon">üí∞</span>
              <span>{{ lastRewards.gold }} Gold</span>
            </div>
          }
          @for (item of lastRewards.items; track item.instanceId) {
            <div class="reward-item">
              <span class="reward-icon">üì¶</span>
              <span>{{ item.itemId }} x{{ item.quantity }}</span>
            </div>
          }
          @for (exp of lastRewards.experience | keyvalue; track exp.key) {
            <div class="reward-item">
              <span class="reward-icon">‚≠ê</span>
              <span>{{ exp.key }}: +{{ exp.value.skill?.leveledUp ? exp.value.skill.newLevel : exp.value.level }}
                XP</span>
              @if (exp.value.leveledUp || exp.value.skill?.leveledUp) {
                <span class="level-up">LEVEL UP!</span>
              }
            </div>
          }
        </div>
      </div>
    }
  </div>
}
