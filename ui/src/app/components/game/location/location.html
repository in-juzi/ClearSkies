<div class="location-container">
  <!-- Traveling State -->
  <div class="traveling-view" *ngIf="travelState()?.isTravel">
    <h2>Traveling...</h2>
    <div class="travel-progress">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="getTravelProgressPercent()"></div>
      </div>
      <p>Destination: {{ currentLocation()?.name }}</p>
      <p>Time remaining: {{ formatTime(travelState()?.remainingTime || 0) }}</p>
    </div>
    <div class="travel-actions">
      <button (click)="skipTravel()" class="btn-warning" title="Skip to 1 second before arrival (Dev feature)">
        Skip
      </button>
      <button (click)="cancelTravel()" class="btn-danger">
        Cancel
      </button>
    </div>
  </div>

  <!-- Main Location View (no activity, no travel) -->
  <div class="main-view" *ngIf="!travelState()?.isTravel && currentLocation()">
    <!-- Location Header -->
    <div class="location-header" [style.background-color]="currentLocation()?.biome?.theme?.primaryColor">
      <h1>{{ currentLocation()?.name }}</h1>
      <p class="location-description">{{ currentLocation()?.description }}</p>
      <span class="biome-badge" [style.background-color]="currentLocation()?.biome?.theme?.accentColor">
        {{ currentLocation()?.biome?.name }}
      </span>
    </div>

    @if (activeActivity()?.activityId && activityProgress()) {

    <button (click)="cancelActivity()" class="btn-back">‚Üê Back to Activities</button>

    <!-- Active Activity State -->
    <div class="activity-view">
      <h2>{{ activeActivityName() || 'Activity in Progress' }}</h2>
      <div class="activity-progress">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="getActivityProgressPercent()"></div>
        </div>
        <p>
          Time remaining: {{ formatTime(activityProgress()?.remainingTime || 0) }}
        </p>
      </div>

      <!-- Skill Training Display -->
      <div class="skill-training" *ngIf="activeSkill()">
        <div class="skill-training-header">
          <img [src]="getSkillIcon(activeSkill()!.name)" [alt]="getSkillDisplayName(activeSkill()!.name)"
            class="skill-icon" loading="lazy">
          <div class="skill-title-section">
            <h3>{{ getSkillDisplayName(activeSkill()!.name) }}</h3>
            <span class="training-label">Training</span>
          </div>
        </div>
        <div class="skill-info">
          <div class="skill-header">
            <span class="skill-level">Level {{ activeSkill()!.skill.level }}</span>
            <span class="skill-xp">{{ getExperienceToNext(activeSkill()!.skill.experience) }} XP to level</span>
          </div>
          <div class="xp-bar">
            <div class="xp-fill" [style.width.%]="activeSkill()!.skill.progress"></div>
          </div>
        </div>
      </div>

      <!-- Activity Log -->
      <div class="activity-log" *ngIf="activityLog.length > 0">
        <h3>Recent Completions</h3>
        <div class="log-entries">
          <div *ngFor="let entry of activityLog" class="log-entry">
            <div class="log-timestamp">{{ entry.timestamp | date:'HH:mm:ss' }}</div>
            <div class="log-content">
              <!-- <div class="log-activity">{{ entry.activityName }}</div> -->
              <div class="log-rewards">
                @if (entry.rewards.gold > 0) {
                <span class="reward-mini gold">üí∞ {{ entry.rewards.gold }}</span>
                }
                @for (item of entry.rewards.items; track item.instanceId) {
                <app-item-mini [item]="item"></app-item-mini>
                }
                @for (exp of entry.rewards.experience | keyvalue; track exp.key) {
                <app-xp-mini [skillName]="exp.key" [xp]="exp.value.skill?.experience || exp.value.experience"
                  [rawXp]="entry.rewards.rawExperience?.[exp.key]" [showIcon]="true" [showSkillName]="true"
                  [showScaling]="true">
                </app-xp-mini>
                @if (exp.value.leveledUp || exp.value.skill?.leveledUp) {
                <span class="level-up-mini">‚Üë</span>
                }
                }
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Rewards Display -->
      <div class="rewards-display" *ngIf="lastRewards">
        <h3>Rewards Received!</h3>
        <div class="reward-items">
          <div *ngIf="lastRewards.gold > 0" class="reward-item">
            <span class="reward-icon">üí∞</span>
            <span>{{ lastRewards.gold }} Gold</span>
          </div>
          <div *ngFor="let item of lastRewards.items" class="reward-item">
            <span class="reward-icon">üì¶</span>
            <span>{{ item.itemId }} x{{ item.quantity }}</span>
          </div>
          <div *ngFor="let exp of lastRewards.experience | keyvalue" class="reward-item">
            <span class="reward-icon">‚≠ê</span>
            <span>{{ exp.key }}: +{{ exp.value.skill?.leveledUp ? exp.value.skill.newLevel : exp.value.level }}
              XP</span>
            <span *ngIf="exp.value.leveledUp || exp.value.skill?.leveledUp" class="level-up">LEVEL UP!</span>
          </div>
        </div>
      </div>
    </div>

    }
    @else {

    <!-- Activity Detail View -->
    <div class="activity-detail" *ngIf="selectedActivity()">
      <button (click)="backToActivities()" class="btn-back">‚Üê Back to Activities</button>
      <h2>{{ selectedActivity()!.name }}</h2>
      <p>{{ selectedActivity()!.description }}</p>

      <div class="activity-info">
        <div class="info-item" *ngIf="selectedActivity()!.duration !== undefined && selectedActivity()!.duration > 0">
          <strong>Duration:</strong> {{ selectedActivity()!.duration }}s
        </div>
        <div class="info-item">
          <strong>Type:</strong> {{ selectedActivity()!.type }}
        </div>
        <div class="info-item" *ngIf="selectedActivity()!.type === 'combat' && selectedActivity()!.monsterLevel">
          <strong>Monster Level:</strong> {{ selectedActivity()!.monsterLevel }}
        </div>
      </div>

      <div class="requirements" *ngIf="hasRequirements(selectedActivity())">
        <h3>Requirements</h3>
        <ul>
          <li *ngFor="let skill of selectedActivity()!.requirements.skills | keyvalue">
            {{ skill.key }} Level {{ skill.value }}
          </li>
          <li *ngFor="let attr of selectedActivity()!.requirements.attributes | keyvalue">
            {{ attr.key }} Level {{ attr.value }}
          </li>
          <li *ngFor="let equipped of selectedActivity()!.requirements.equipped">
            {{ equipped.subtype }} equipped
          </li>
          <li *ngFor="let inv of selectedActivity()!.requirements.inventory">
            {{ inv.quantity || 1 }}x {{ inv.itemId }} in inventory
          </li>
        </ul>
        <div class="requirement-failures"
          *ngIf="selectedActivity()?.requirementFailures && (selectedActivity()?.requirementFailures?.length ?? 0) > 0">
          <p class="error">Not met:</p>
          <ul>
            <li *ngFor="let failure of selectedActivity()?.requirementFailures">{{ failure }}</li>
          </ul>
        </div>
      </div>

      <div class="rewards" *ngIf="selectedActivity()!.rewards">
        <h3>Rewards</h3>
        <ul>
          <li *ngFor="let exp of selectedActivity()!.rewards.experience | keyvalue">
            {{ exp.key }}: +{{ exp.value }} XP
          </li>
          <li *ngFor="let item of selectedActivity()!.rewards.items">
            {{ item.itemId }} ({{ item.quantity.min }}-{{ item.quantity.max }}) - {{ (item.chance * 100).toFixed(0) }}%
            chance
          </li>
          <li *ngIf="selectedActivity()?.rewards?.gold">
            Gold: {{ selectedActivity()?.rewards?.gold?.min }}-{{ selectedActivity()?.rewards?.gold?.max }}
          </li>
        </ul>
      </div>

      <button (click)="startActivity()" [disabled]="!selectedActivity()!.available"
        [class.btn-disabled]="!selectedActivity()!.available" class="btn-primary">
        {{ selectedActivity()!.available ? 'Start Activity' : 'Requirements Not Met' }}
      </button>
    </div>

    <!-- Vendor View (shown when vendor is open) -->
    <div class="vendor-view" *ngIf="selectedFacility() && vendorService.isVendorOpen()">
      <app-vendor></app-vendor>
    </div>

    <!-- Combat Section (when in combat or combat ended for review) - MOVED OUTSIDE facility detail -->
    <div class="combat-section" *ngIf="inCombat() || combatService.combatEnded()">
      <!-- Return to Facility Button (shown during combat or after combat ends) -->
      <button (click)="fleeCombat()" class="btn-back">‚Üê Return to Facility</button>

      <app-combat></app-combat>
    </div>

    <!-- Facility Detail View (shown when facility is selected but vendor is not open and not in combat) -->
    <div class="facility-detail" *ngIf="selectedFacility() && !selectedActivity() && !vendorService.isVendorOpen() && !inCombat() && !combatService.combatEnded()">
      <button (click)="backToFacilities()" class="btn-back">‚Üê Back to Facilities</button>
      <h2>{{ selectedFacility()?.name }}</h2>
      <p>{{ selectedFacility()?.description }}</p>

      <!-- Merchants/Vendors Section -->
      <div class="vendors-section" *ngIf="getVendorIds(selectedFacility()).length > 0">
        <h3>Merchants</h3>
        <div class="vendors-list">
          <button *ngFor="let vendorId of getVendorIds(selectedFacility())" class="vendor-card"
            (click)="openVendor(vendorId)">
            <div class="vendor-info">
              <span class="vendor-name">
                {{ getVendor(vendorId)?.name || 'Merchant' }}
              </span>
              <span class="vendor-greeting" *ngIf="getVendor(vendorId)?.greeting">
                {{ getVendor(vendorId)?.greeting }}
              </span>
            </div>
          </button>
        </div>
      </div>

      <!-- Crafting Section (for crafting-type facilities) -->
      <div class="crafting-section" *ngIf="selectedFacility()?.type === 'crafting'">
        <app-crafting [skill]="getCraftingSkill(selectedFacility())"
          [facilityId]="selectedFacility()?.facilityId || ''">
        </app-crafting>
      </div>

      <!-- Activities Section -->
      <h3 *ngIf="selectedFacility()?.activities && selectedFacility()!.activities.length > 0">Activities</h3>
      <div class="activities-list">
        <div *ngFor="let activity of selectedFacility()?.activities" class="activity-card"
          [class.available]="activity.available" [class.unavailable]="!activity.available"
          (click)="selectActivity(activity)">
          <h4>{{ activity.name }}</h4>
          <p>{{ activity.description }}</p>
          <div class="activity-meta">
            <span *ngIf="activity.duration !== undefined && activity.duration > 0">‚è±Ô∏è {{ activity.duration }}s</span>
            <span *ngIf="activity.type === 'combat' && activity.monsterLevel">‚öîÔ∏è Level {{ activity.monsterLevel }}</span>
            <span *ngIf="!activity.available" class="unavailable-badge">Requirements Not Met</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Facility List View (shown when no facility is selected and not in combat) -->
    <div class="facilities-view" *ngIf="!selectedFacility() && !vendorService.isVendorOpen() && !inCombat() && !combatService.combatEnded()">
      <h2>Facilities</h2>
      <div class="facilities-list">
        <div *ngFor="let facility of currentLocation()?.facilities" class="facility-card"
          (click)="selectFacility(facility)">
          <h3>{{ facility.name }}</h3>
          <p>{{ facility.description }}</p>
          <span class="facility-type">{{ facility.type }}</span>
        </div>
      </div>

      <!-- Navigation Links -->
      <div class="navigation-section"
        *ngIf="currentLocation()?.navigationLinks && currentLocation()!.navigationLinks.length > 0">
        <h2>Travel</h2>
        <div class="navigation-list">
          <div *ngFor="let link of currentLocation()?.navigationLinks" class="nav-link"
            [class.available]="link.available" [class.unavailable]="!link.available">
            <h3>{{ link.name }}</h3>
            <p>{{ link.description }}</p>
            <div class="nav-meta">
              <span>‚è±Ô∏è {{ link.travelTime }}s</span>
              <span *ngIf="!link.available" class="unavailable-badge">Requirements Not Met</span>
            </div>
            <div class="requirement-failures" *ngIf="link.requirementFailures && link.requirementFailures.length > 0">
              <p class="error">Not met:</p>
              <ul>
                <li *ngFor="let failure of link.requirementFailures">{{ failure }}</li>
              </ul>
            </div>
            <button *ngIf="link.available" (click)="travel(link.targetLocationId)" class="btn-primary">
              Travel
            </button>
          </div>
        </div>
      </div>
    </div>

    }
  </div>
</div>