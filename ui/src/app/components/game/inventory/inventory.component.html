<div class="inventory-container">
  <!-- Header -->
  <div class="inventory-header">
    <h2 class="text-2xl font-bold text-gold-400">Inventory</h2>
  </div>

  <!-- Category Filter -->
  <div class="category-filter">
    <button
      *ngFor="let category of categories"
      [class.active]="selectedCategory === category.value"
      (click)="selectedCategory = category.value"
      class="category-btn">
      {{ category.shortLabel }}
    </button>
  </div>

  <!-- Inventory Grid -->
  <div class="inventory-grid">
    <div
      *ngFor="let item of getFilteredInventory()"
      class="inventory-item"
      [class]="getRarityClass(item.definition.rarity)"
      [class.equipped]="item.equipped"
      [draggable]="true"
      (click)="selectItem(item)"
      (dragstart)="onItemDragStart($event, item)"
      (dragend)="onItemDragEnd($event)">
      <!-- Item icon (left side) -->
      <div class="item-icon">
        <app-icon
          *ngIf="item.definition.icon"
          [icon]="item.definition.icon"
          [size]="40"
          [alt]="item.definition.name">
        </app-icon>
        <span *ngIf="!item.definition.icon" class="item-tier">T{{ item.definition.properties.tier }}</span>
      </div>

      <!-- Item content (right side - vertical stack) -->
      <div class="item-content">
        <!-- Top row: Name + Quantity -->
        <div class="item-header">
          <div class="item-name" [class]="inventoryService.getRarityColor(item.definition.rarity)">
            {{ item.definition.name }}
          </div>
          <div class="item-quantity" *ngIf="item.quantity > 1">x{{ item.quantity }}</div>
        </div>

        <!-- Bottom row: Quality/Trait badges -->
        <div class="item-badges">
          <app-item-modifiers [item]="item" displayMode="badge-level" size="normal"></app-item-modifiers>
        </div>
      </div>
    </div>

    <!-- Empty slots -->
    <div *ngIf="getFilteredInventory().length === 0" class="empty-message">
      <p>No items in this category</p>
    </div>
  </div>

  <!-- Item Details Panel -->
  <div
    class="item-details-panel"
    *ngIf="selectedItem"
    #detailsPanel
    [style.left]="panelLeft"
    [style.top]="panelTop"
    [style.transform]="panelTransform"
    (mousedown)="onDragStart($event, detailsPanel)">
    <div class="details-header">
      <h3 [class]="inventoryService.getRarityColor(selectedItem.definition.rarity)">
        {{ selectedItem.definition.name }}
      </h3>
      <button (click)="closeItemDetails()" class="close-btn close-button">‚úï</button>
    </div>

    <div class="details-content">
      <!-- Item Icon and Description -->
      <div class="detail-icon-description-section">
        <div class="detail-icon-wrapper" *ngIf="selectedItem.definition.icon">
          <app-icon
            [icon]="selectedItem.definition.icon"
            [size]="80"
            [alt]="selectedItem.definition.name">
          </app-icon>
        </div>
        <p class="item-description">{{ selectedItem.definition.description }}</p>
      </div>

      <!-- Basic Info -->
      <div class="detail-section">
        <div class="detail-row">
          <span class="label">Category:</span>
          <span>{{ selectedItem.definition.category }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Rarity:</span>
          <span [class]="inventoryService.getRarityColor(selectedItem.definition.rarity)">
            {{ selectedItem.definition.rarity }}
          </span>
        </div>
        <div class="detail-row">
          <span class="label">Quantity:</span>
          <span>{{ selectedItem.quantity }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Weight:</span>
          <span>{{ selectedItem.definition.properties.weight.toFixed(1) }} kg</span>
        </div>
        <div class="detail-row">
          <span class="label">Value:</span>
          <span class="text-gold-400">{{ selectedItem.vendorPrice }}g each</span>
        </div>
      </div>

      <!-- Subcategories -->
      <div class="detail-section" *ngIf="selectedItem.definition.subcategories && selectedItem.definition.subcategories.length > 0">
        <h4 class="section-title">Categories</h4>
        <div class="subcategories-list">
          <span class="subcategory-tag" *ngFor="let subcategory of selectedItem.definition.subcategories">
            {{ subcategory }}
          </span>
        </div>
      </div>

      <!-- Qualities -->
      <div class="detail-section" *ngIf="getQualityKeys(selectedItem.qualityDetails).length > 0">
        <h4 class="section-title">Qualities</h4>
        <div class="quality-list">
          <div *ngFor="let qualityId of getQualityKeys(selectedItem.qualityDetails)" class="quality-item">
            <div class="quality-header">
              <span class="quality-name">{{ selectedItem.qualityDetails[qualityId].name }}</span>
              <span [class]="inventoryService.getQualityColor(selectedItem.qualityDetails[qualityId].level)" class="quality-level-badge">
                Level {{ selectedItem.qualityDetails[qualityId].level }}
              </span>
            </div>
            <div class="quality-level-name" [class]="inventoryService.getQualityColor(selectedItem.qualityDetails[qualityId].level)">
              {{ selectedItem.qualityDetails[qualityId].levelData.name }}
            </div>
            <p class="quality-description">{{ selectedItem.qualityDetails[qualityId].levelData.description }}</p>

            <!-- Effects -->
            <div class="effects-section" *ngIf="selectedItem.qualityDetails[qualityId].levelData.effects">
              <div class="effect-label">Effects:</div>
              <div class="effects-grid">
                <div *ngFor="let effect of getQualityKeys(selectedItem.qualityDetails[qualityId].levelData.effects)" class="effect-item">
                  <span class="effect-type">{{ formatEffectType(effect) }}:</span>
                  <span class="effect-value">{{ formatEffectValue(selectedItem.qualityDetails[qualityId].levelData.effects[effect]) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Traits -->
      <div class="detail-section" *ngIf="getQualityKeys(selectedItem.traitDetails).length > 0">
        <h4 class="section-title">Traits</h4>
        <div class="trait-list">
          <div *ngFor="let traitId of getQualityKeys(selectedItem.traitDetails)" class="trait-item" [class]="'trait-rarity-' + selectedItem.traitDetails[traitId].rarity">
            <div class="trait-header">
              <span [class]="inventoryService.getRarityColor(selectedItem.traitDetails[traitId].rarity)" class="trait-name">
                {{ selectedItem.traitDetails[traitId].name }}
              </span>
              <div class="trait-badges">
                <span class="trait-rarity-badge" [class]="inventoryService.getRarityColor(selectedItem.traitDetails[traitId].rarity)">
                  {{ selectedItem.traitDetails[traitId].rarity }}
                </span>
                <span [class]="inventoryService.getTraitLevelColor(selectedItem.traitDetails[traitId].level)" class="trait-level-badge">
                  Level {{ selectedItem.traitDetails[traitId].level }}
                </span>
              </div>
            </div>
            <div class="trait-level-name" [class]="inventoryService.getRarityColor(selectedItem.traitDetails[traitId].rarity)">
              {{ selectedItem.traitDetails[traitId].levelData.name }}
            </div>
            <p class="trait-description">{{ selectedItem.traitDetails[traitId].levelData.description }}</p>

            <!-- Effects -->
            <div class="effects-section" *ngIf="selectedItem.traitDetails[traitId].levelData.effects">
              <div class="effect-label">Effects:</div>
              <div class="effects-grid">
                <div *ngFor="let effect of getQualityKeys(selectedItem.traitDetails[traitId].levelData.effects)" class="effect-item">
                  <span class="effect-type">{{ formatEffectType(effect) }}:</span>
                  <span class="effect-value">{{ formatEffectValue(selectedItem.traitDetails[traitId].levelData.effects[effect]) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions Footer (always visible) -->
    <div class="details-footer">
      <!-- Quantity Controls (only show if quantity > 1) -->
      <div class="drop-quantity-controls" *ngIf="selectedItem.quantity > 1">
        <div class="quantity-header">
          <label class="quantity-label">Drop Quantity:</label>
          <div class="quantity-input-group">
            <input
              type="number"
              class="quantity-input"
              [(ngModel)]="dropQuantity"
              (ngModelChange)="updateDropQuantity($event)"
              [min]="1"
              [max]="getMaxDropQuantity()"
              [disabled]="!!selectedItem.equipped"
            />
            <span class="quantity-max">/ {{ selectedItem.quantity }}</span>
          </div>
        </div>
        <input
          type="range"
          class="quantity-slider"
          [(ngModel)]="dropQuantity"
          (ngModelChange)="updateDropQuantity($event)"
          [min]="1"
          [max]="getMaxDropQuantity()"
          [disabled]="!!selectedItem.equipped"
        />
      </div>

      <div class="detail-actions">
        <button class="btn-primary" *ngIf="selectedItem.definition.category === 'consumable'">
          Use
        </button>
        <button class="btn-primary" *ngIf="selectedItem.definition.category === 'equipment' && !selectedItem.equipped">
          Equip
        </button>
        <button class="btn-secondary" *ngIf="selectedItem.definition.category === 'equipment' && selectedItem.equipped">
          Unequip
        </button>
        <button
          class="btn-danger"
          *ngIf="selectedItem.quantity > 1"
          (click)="removeItem(selectedItem.instanceId)"
          [disabled]="!!selectedItem.equipped">
          Drop ({{ dropQuantity }})
        </button>
        <button
          class="btn-danger"
          (click)="removeAllItems(selectedItem.instanceId)"
          [disabled]="!!selectedItem.equipped">
          Drop All
        </button>
      </div>
    </div>
  </div>

  <!-- Inventory Stats (at bottom) -->
  <div class="inventory-stats-container">
    <div class="inventory-stats">
      <div class="stat-item">
        <span class="stat-icon">üì¶</span>
        <div class="stat-content">
          <span class="stat-label">Capacity</span>
          <span class="stat-value">{{ inventoryService.inventorySize() }} / {{ inventoryService.inventoryCapacity() }}</span>
        </div>
      </div>
      <div class="stat-item">
        <span class="stat-icon">‚öñÔ∏è</span>
        <div class="stat-content">
          <span class="stat-label">Weight</span>
          <span class="stat-value">{{ getTotalWeight().toFixed(1) }} kg</span>
        </div>
      </div>
      <div class="stat-item">
        <span class="stat-icon">üí∞</span>
        <div class="stat-content">
          <span class="stat-label">Gold</span>
          <span class="stat-value text-gold-400">{{ inventoryService.gold() }} g</span>
        </div>
      </div>
    </div>
  </div>

</div>
