<div class="inventory-container">
  <!-- Header -->
  <div class="inventory-header">
    <h2 class="text-2xl font-bold text-gold-400">Inventory</h2>
    <div class="header-actions">
      <!-- View Mode Toggle -->
      <div class="view-toggle-group">
        <button
          class="view-toggle-btn"
          [class.active]="viewMode === 'list'"
          (click)="viewMode = 'list'"
          title="List View">
          <span class="material-symbols-outlined">list</span>
        </button>
        <button
          class="view-toggle-btn"
          [class.active]="viewMode === 'grouped'"
          (click)="viewMode = 'grouped'"
          title="Grouped View">
          <span class="material-symbols-outlined">view_compact_alt</span>
        </button>
      </div>
      @if (isAltKeyHeld) {
        <div class="alt-hint">
          <span class="hint-icon">‚ö°</span>
          <span class="hint-text">{{ vendorService.isVendorOpen() ? 'Quick Sell Mode' : 'Quick Drop Mode' }}</span>
        </div>
      }
    </div>
  </div>

  <!-- Filters -->
  <div class="filters">
    <select [(ngModel)]="selectedCategory" class="category-filter">
      @for (category of categories; track category.value) {
        <option [value]="category.value">
          {{ category.label }}
        </option>
      }
    </select>

    <input
      type="text"
      [(ngModel)]="searchQuery"
      placeholder="Search items..."
      class="search-input"
    />
  </div>

  <!-- List View (Original) -->
  @if (viewMode === 'list') {
    <div class="inventory-grid">
      @for (item of getFilteredInventory(); track item.instanceId) {
        <div
          class="inventory-item"
          [class]="getRarityClass(item.definition.rarity)"
          [class.equipped]="item.equipped"
          [class.alt-sell-mode]="isAltKeyHeld && vendorService.isVendorOpen()"
          [class.alt-drop-mode]="isAltKeyHeld && !vendorService.isVendorOpen()"
          [draggable]="true"
          (click)="onItemClick($event, item)"
          (contextmenu)="onItemRightClick($event, item)"
          (dragstart)="onItemDragStart($event, item)"
          (dragend)="onItemDragEnd($event)"
          [title]="getItemTooltip(item)">
          <!-- Item icon (left side) -->
          <div class="item-icon">
            @if (item.definition.icon) {
              <app-icon
                [icon]="item.definition.icon"
                [size]="40"
                [alt]="item.definition.name">
              </app-icon>
            } @else {
              <span class="item-tier">T{{ item.definition.properties.tier }}</span>
            }
          </div>

          <!-- Item content (right side - vertical stack) -->
          <div class="item-content">
            <!-- Top row: Name + Quantity -->
            <div class="item-header">
              <div class="item-name" [class]="inventoryService.getRarityColor(item.definition.rarity)">
                {{ item.definition.name }}
              </div>
              @if (item.quantity > 1) {
                <div class="item-quantity">x{{ item.quantity }}</div>
              }
            </div>

            <!-- Bottom row: Quality/Trait badges -->
            <div class="item-badges">
              <app-item-modifiers [item]="item" displayMode="badge-level" size="normal"></app-item-modifiers>
            </div>
          </div>
        </div>
      }

      <!-- Empty slots -->
      @if (getFilteredInventory().length === 0) {
        <div class="empty-message">
          <p>No items in this category</p>
        </div>
      }
    </div>
  }

  <!-- Grouped View (New) -->
  @if (viewMode === 'grouped') {
    <div class="inventory-grid">
      @for (group of getGroupedInventory(); track group.definition.itemId) {
        <div class="item-group">
          <!-- Group Header (Item Definition) -->
          <div
            class="group-header"
            [class]="getRarityClass(group.definition.rarity)"
            (click)="toggleGroup(group)">
            <!-- Item icon -->
            <div class="item-icon">
              @if (group.definition.icon) {
                <app-icon
                  [icon]="group.definition.icon"
                  [size]="40"
                  [alt]="group.definition.name">
                </app-icon>
              } @else {
                <span class="item-tier">T{{ group.definition.properties.tier }}</span>
              }
            </div>

            <!-- Group info -->
            <div class="group-info">
              <div class="group-name" [class]="inventoryService.getRarityColor(group.definition.rarity)">
                {{ group.definition.name }}
              </div>
              <div class="group-meta">
                <span class="group-count">{{ group.instances.length }} stack{{ group.instances.length !== 1 ? 's' : '' }}</span>
                <span class="group-quantity">{{ group.totalQuantity }} total</span>
              </div>
            </div>

            <!-- Expand/Collapse indicator -->
            <div class="expand-indicator">
              @if (!group.isExpanded) {
                <span>‚ñº</span>
              } @else {
                <span>‚ñ≤</span>
              }
            </div>
          </div>

          <!-- Group Instances (Expanded) -->
          @if (group.isExpanded) {
            <div class="group-instances">
              @for (instance of group.instances; track instance.instanceId) {
                <app-item-mini
                  [item]="instance"
                  [showIcon]="false"
                  [showItemId]="false"
                  [showQuantity]="true"
                  [showModifiers]="true"
                  [iconSize]="24"
                  [class.equipped]="instance.equipped"
                  [class.alt-sell-mode]="isAltKeyHeld && vendorService.isVendorOpen()"
                  [class.alt-drop-mode]="isAltKeyHeld && !vendorService.isVendorOpen()"
                  [draggable]="true"
                  (click)="onItemClick($event, instance)"
                  (contextmenu)="onItemRightClick($event, instance)"
                  (dragstart)="onItemDragStart($event, instance)"
                  (dragend)="onItemDragEnd($event)"
                  [title]="getItemTooltip(instance)">
                </app-item-mini>
              }
            </div>
          }
        </div>
      }

      <!-- Empty message -->
      @if (getGroupedInventory().length === 0) {
        <div class="empty-message">
          <p>No items in this category</p>
        </div>
      }
    </div>
  }

  <!-- Item Details Panel (Shared Component) -->
  @if (selectedItem) {
    <app-item-details-panel
      [item]="selectedItem"
      [showActions]="true"
      [showDropControls]="true"
      (close)="closeItemDetails()"
      (equipItem)="equipItem($event)"
      (unequipItem)="unequipItem($event)"
      (useItem)="useItem($event)"
      (removeItem)="removeItem($event.instanceId, $event.quantity)"
      (removeAllItems)="removeAllItems($event)">
    </app-item-details-panel>
  }

  <!-- Inventory Stats (at bottom) -->
  <div class="inventory-stats-container">
    <div class="inventory-stats">
      <div class="stat-item">
        <span class="stat-icon">‚öñÔ∏è</span>
        <div class="stat-content">
          <span class="stat-label">Carrying Capacity</span>
          <span class="stat-value"
                [class.weight-normal]="getWeightPercent() < 80"
                [class.weight-warning]="getWeightPercent() >= 80 && getWeightPercent() < 95"
                [class.weight-critical]="getWeightPercent() >= 95">
            {{ inventoryService.currentWeight().toFixed(1) }} / {{ inventoryService.carryingCapacity().toFixed(1) }} kg
          </span>
        </div>
      </div>
      <div class="stat-item">
        <span class="stat-icon">üì¶</span>
        <div class="stat-content">
          <span class="stat-label">Item Count</span>
          <span class="stat-value">{{ inventoryService.inventorySize() }}</span>
        </div>
      </div>
      <div class="stat-item gold-stat-item">
        <!-- Floating Gold Notifications -->
        <div class="floating-gold-container">
          @for (goldNotif of floatingGold(); track goldNotif.id) {
            <div class="floating-gold">
              +{{ goldNotif.amount }}g
            </div>
          }
        </div>

        <span class="stat-icon">üí∞</span>
        <div class="stat-content">
          <span class="stat-label">Gold</span>
          <span class="stat-value text-gold-400">{{ inventoryService.gold() }} g</span>
        </div>
      </div>
    </div>
  </div>

</div>
