<div class="inventory-grid">
  @for (group of groups; track group.definition.itemId) {
    <div class="item-group">
      <!-- Group Header (Item Definition) -->
      <div
        class="group-header"
        [class]="group.definition.rarity | rarityClass"
        (click)="onGroupToggle(group)">
        <!-- Item icon -->
        <div class="item-icon">
          @if (group.definition.icon) {
            <app-icon
              [icon]="group.definition.icon"
              [size]="40"
              [alt]="group.definition.name">
            </app-icon>
          } @else {
            <span class="item-tier">T{{ group.definition.properties.tier }}</span>
          }
        </div>

        <!-- Group info -->
        <div class="group-info">
          <div class="group-name" [class]="group.definition.rarity | rarityColor">
            {{ group.definition.name }}
          </div>
          <div class="group-meta">
            <span class="group-count">{{ group.instances.length }} stack{{ group.instances.length !== 1 ? 's' : '' }}</span>
            <span class="group-quantity">{{ group.totalQuantity }} total</span>
          </div>
        </div>

        <!-- Expand/Collapse indicator -->
        <div class="expand-indicator">
          @if (!group.isExpanded) {
            <span>▼</span>
          } @else {
            <span>▲</span>
          }
        </div>
      </div>

      <!-- Group Instances (Expanded) -->
      @if (group.isExpanded) {
        <div class="group-instances">
          @for (instance of group.instances; track instance.instanceId) {
            <app-item-mini
              [item]="instance"
              [showIcon]="false"
              [showItemId]="false"
              [showQuantity]="true"
              [showModifiers]="true"
              [iconSize]="24"
              [class.equipped]="instance.equipped"
              [class.alt-sell-mode]="isAltKeyHeld && isVendorOpen"
              [class.alt-drop-mode]="isAltKeyHeld && !isVendorOpen"
              [draggable]="true"
              (click)="onItemClick($event, instance)"
              (contextmenu)="onItemRightClick($event, instance)"
              (dragstart)="onItemDragStart($event, instance)"
              (dragend)="onItemDragEnd($event)"
              [title]="getItemTooltip(instance)">
            </app-item-mini>
          }
        </div>
      }
    </div>
  }

  <!-- Empty message -->
  @if (groups.length === 0) {
    <div class="empty-message">
      <p>No items in this category</p>
    </div>
  }
</div>
