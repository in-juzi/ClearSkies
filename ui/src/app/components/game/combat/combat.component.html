<!-- Combat Arena -->
@if (activeCombat(); as combat) {
  <div class="combat-container">
    <!-- Combatants Display -->
    <div class="combatants">
      <!-- Player Side -->
      <div class="combatant player-side">
        <!-- Floating Numbers Container -->
        <div class="floating-numbers-container">
          @for (floatNum of floatingNumbers(); track floatNum.id) {
            @if (floatNum.target === 'player') {
              <div class="floating-number"
                   [class.damage]="floatNum.type === 'damage'"
                   [class.crit]="floatNum.type === 'crit'"
                   [class.heal]="floatNum.type === 'heal'">
                {{ floatNum.type === 'heal' ? '+' : '-' }}{{ floatNum.value }}
              </div>
            }
          }
        </div>
        <div class="combatant-info">
          <div class="combatant-name">{{ authService.currentUser()?.username || 'You' }}</div>
          <div class="combatant-level">Level {{ player()?.level || 1 }}</div>
        </div>

        <!-- Attack Timer -->
        <div class="attack-timer">
          <div class="timer-info">
            <span class="timer-label">Next Attack:</span>
            <span class="timer-value" [class.ready]="playerAttackTimer() <= 0">
              {{ formatTimer(playerAttackTimer()) }}
            </span>
          </div>
          <div class="timer-bar-bg">
            <div class="timer-bar-fill"
                 [style.width.%]="playerAttackTimerPercent()"
                 [style.background-color]="playerAttackTimerPercent() >= 100 ? '#4ade80' : '#8b5cf6'"></div>
          </div>
        </div>

        <!-- Player HP Bar -->
        <div class="hp-bar-container">
          <div class="hp-bar-label">
            <span>HP</span>
            <span>{{ combat.playerHealth.current }} / {{ combat.playerHealth.max }}</span>
          </div>
          <div class="hp-bar-bg">
            <div class="hp-bar-fill"
                 [style.width.%]="playerHpPercent()"
                 [style.background-color]="playerHpColor()"></div>
          </div>
        </div>

        <!-- Player Mana Bar -->
        <div class="mana-bar-container">
          <div class="mana-bar-label">
            <span>Mana</span>
            <span>{{ combat.playerMana.current }} / {{ combat.playerMana.max }}</span>
          </div>
          <div class="mana-bar-bg">
            <div class="mana-bar-fill"
                 [style.width.%]="playerManaPercent()"
                 [style.background-color]="'#3b82f6'"></div>
          </div>
        </div>

        <!-- Active Buffs (Player) -->
        @if (combat.activeBuffs && combat.activeBuffs.length > 0) {
          <div class="buffs-container">
            @for (buff of combat.activeBuffs; track buff.buffId) {
              @if (buff.target === 'player') {
                <app-buff-icon [buff]="buff" [size]="36"></app-buff-icon>
              }
            }
          </div>
        }
      </div>

      <!-- VS Indicator -->
      <div class="vs-indicator">
        <div class="turn-display">Turn {{ combat.turnCount }}</div>
        <div class="vs-text">VS</div>
      </div>

      <!-- Monster Side -->
      <div class="combatant monster-side">
        <!-- Floating Numbers Container -->
        <div class="floating-numbers-container">
          @for (floatNum of floatingNumbers(); track floatNum.id) {
            @if (floatNum.target === 'monster') {
              <div class="floating-number"
                   [class.damage]="floatNum.type === 'damage'"
                   [class.crit]="floatNum.type === 'crit'"
                   [class.heal]="floatNum.type === 'heal'">
                {{ floatNum.type === 'heal' ? '+' : '-' }}{{ floatNum.value }}
              </div>
            }
          }
        </div>
        <div class="combatant-info">
          <div class="combatant-name">{{ combat.monsterName }}</div>
          <div class="combatant-level">Level {{ combat.monsterLevel }}</div>
        </div>

        <!-- Attack Timer -->
        <div class="attack-timer">
          <div class="timer-info">
            <span class="timer-label">Next Attack:</span>
            <span class="timer-value" [class.ready]="monsterAttackTimer() <= 0">
              {{ formatTimer(monsterAttackTimer()) }}
            </span>
          </div>
          <div class="timer-bar-bg">
            <div class="timer-bar-fill"
                 [style.width.%]="monsterAttackTimerPercent()"
                 [style.background-color]="monsterAttackTimerPercent() >= 100 ? '#4ade80' : '#8b5cf6'"></div>
          </div>
        </div>

        <!-- Monster HP Bar -->
        <div class="hp-bar-container">
          <div class="hp-bar-label">
            <span>HP</span>
            <span>{{ combat.monsterHealth.current }} / {{ combat.monsterHealth.max }}</span>
          </div>
          <div class="hp-bar-bg">
            <div class="hp-bar-fill"
                 [style.width.%]="monsterHpPercent()"
                 [style.background-color]="monsterHpColor()"></div>
          </div>
        </div>

        <!-- Active Debuffs (Monster) -->
        @if (combat.activeBuffs && combat.activeBuffs.length > 0) {
          <div class="buffs-container">
            @for (buff of combat.activeBuffs; track buff.buffId) {
              @if (buff.target === 'monster') {
                <app-buff-icon [buff]="buff" [size]="36"></app-buff-icon>
              }
            }
          </div>
        }
      </div>
    </div>

    <!-- Action Bar -->
    <div class="action-bar">
      <!-- Combat Ended - New Encounter Button -->
      @if (combatEnded()) {
        <button
          class="action-button new-encounter-button"
          (click)="startNewEncounter()">
          <span class="button-icon">ðŸ”„</span>
          <span class="button-text">Start New Encounter</span>
        </button>
      }

      <!-- Active Combat Actions -->
      @if (!combatEnded()) {
        <!-- Ability Buttons -->
        @for (ability of combat.availableAbilities; track ability.abilityId) {
          <app-ability-button
            [ability]="ability"
            [disabled]="isExecutingAction() || !canUseAbility(ability)"
            [cooldownRemaining]="getAbilityCooldown(ability)"
            [insufficientResource]="combat.playerMana.current < (ability.manaCost || 0)"
            [resourceLabel]="'Mana'"
            [size]="'medium'"
            (abilityClick)="useAbility($event)">
          </app-ability-button>
        }
      }
    </div>

    <!-- Consumables Section -->
    @if (consumables().length > 0 && !combatEnded()) {
      <div class="consumables-section">
        <div class="consumables-header">
          <span class="consumables-icon">ðŸ§ª</span>
          <span class="consumables-title">Items</span>
        </div>
        <div class="consumables-list">
          @for (item of consumables(); track item.instanceId) {
            <app-item-button
              [item]="item"
              [disabled]="isUsingItem() || isExecutingAction()"
              [size]="'medium'"
              (itemClick)="useConsumable($event)">
            </app-item-button>
          }
        </div>
      </div>
    }

    <!-- Combat Log -->
    <div class="combat-log">
      <div class="combat-log-header">Combat Log</div>
      <div class="combat-log-content" #combatLogContent (scroll)="onCombatLogScroll()">
        @for (entry of combat.combatLog; track entry.timestamp) {
          <div class="log-entry" [class]="getLogEntryClass(entry)">
            <span class="log-timestamp">[{{ formatTimestamp(entry.timestamp) }}]</span>
            <span class="log-message">{{ entry.message }}</span>
            @if (entry.type === 'loot' && entry.items && entry.items.length > 0) {
              <div class="log-items">
                @for (item of entry.items; track item.instanceId) {
                  <app-item-mini
                    [item]="item"
                    [showIcon]="true"
                    [showQuantity]="true"
                    [showItemId]="true"
                    [showDisplayName]="true"
                    [showModifiers]="true"
                    [iconSize]="20">
                  </app-item-mini>
                }
              </div>
            }
          </div>
        }
        @if (combat.combatLog.length === 0) {
          <div class="log-empty">
            No combat events yet...
          </div>
        }
      </div>
    </div>
  </div>
}

<!-- Not in Combat Message -->
@if (!inCombat() && !combatEnded() && !activeCombat()) {
  <div class="no-combat">
    <p>You are not currently in combat.</p>
  </div>
}
