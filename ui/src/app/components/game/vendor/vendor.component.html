@if (vendor(); as currentVendor) {
  <div class="vendor-container">
    <!-- Back Button -->
    <button (click)="closeVendor()" class="button-quaternary">‚Üê Back to Facility</button>

    <!-- Header -->
    <div class="vendor-header">
      <h2>{{ currentVendor.name }}</h2>
      <p class="vendor-greeting">{{ currentVendor.greeting }}</p>
      <p class="vendor-description">{{ currentVendor.description }}</p>
      <div class="player-gold">
        <span class="gold-icon">üí∞</span>
        <span class="gold-amount">{{ playerGold() }} gold</span>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button
        class="tab"
        [class.active]="activeTab() === 'buy'"
        (click)="setTab('buy')">
        Buy
      </button>
      <button
        class="tab"
        [class.active]="activeTab() === 'sell'"
        (click)="setTab('sell')">
        Sell
      </button>
    </div>

    <!-- Buy Tab Content -->
    @if (activeTab() === 'buy') {
      <div class="tab-content buy-tab">
        @if (currentVendor.stock.length === 0) {
          <p class="empty-message">This vendor has no items for sale.</p>
        } @else {
          <div class="stock-list">
            @for (stockItem of currentVendor.stock; track stockItem.itemId) {
              <div class="stock-item" [class.selected]="selectedBuyItem()?.itemId === stockItem.itemId">
                <div class="item-info" (click)="selectBuyItem(stockItem)">
                  @if (stockItem.itemDefinition) {
                    <div class="item-icon">
                      @if (stockItem.itemDefinition.icon) {
                        <app-icon
                          [path]="stockItem.itemDefinition.icon.path"
                          [material]="stockItem.itemDefinition.icon.material"
                          [size]="48">
                        </app-icon>
                      }
                    </div>
                    <div class="item-details">
                      <h4 class="item-name" [ngClass]="stockItem.itemDefinition.rarity | rarityName">
                        {{ stockItem.itemDefinition.name }}
                      </h4>
                      <p class="item-description">{{ stockItem.itemDefinition.description }}</p>
                      <div class="item-meta">
                        <span class="price">üí∞ {{ stockItem.buyPrice }} gold</span>
                        <span class="stock-type">{{ stockItem.stockType === 'infinite' ? '‚àû' : 'Limited' }}</span>
                      </div>
                    </div>
                  }
                </div>
                <div class="item-actions">
                  <button class="button-secondary" (click)="buyItem(stockItem.itemId, 1)">
                    Buy 1
                  </button>
                  <button class="button-secondary" (click)="buyItem(stockItem.itemId, 5)">
                    Buy 5
                  </button>
                  <button class="button-secondary" (click)="buyItem(stockItem.itemId, 10)">
                    Buy 10
                  </button>
                </div>
              </div>
            }
          </div>
        }
      </div>
    }

    <!-- Sell Tab Content -->
    @if (activeTab() === 'sell') {
      <div class="tab-content sell-tab drop-zone"
           (dragover)="onDragOver($event)"
           (drop)="onDrop($event)"
           (dragleave)="onDragLeave($event)"
           [class.drag-over]="isDragOver()">
        @if (getSortedSellableItems().length === 0) {
          <p class="empty-message drop-hint"
             (dragover)="onDragOver($event)"
             (drop)="onDrop($event)">
            You have no items to sell. Drag items from your inventory here to sell them.
          </p>
        } @else {
          <div class="inventory-list"
               (dragover)="onDragOver($event)"
               (drop)="onDrop($event)">
            @for (item of getSortedSellableItems(); track item.instanceId) {
              <div class="inventory-item"
                   (dragover)="onDragOver($event)"
                   (drop)="onDrop($event)">
                <div class="item-info">
                  <div class="item-icon">
                    @if (item.definition.icon) {
                      <app-icon
                        [path]="item.definition.icon.path"
                        [material]="item.definition.icon.material"
                        [size]="48">
                      </app-icon>
                    } @else {
                      <span class="item-tier">T{{ item.definition.properties.tier }}</span>
                    }
                  </div>
                  <div class="item-details">
                    <div class="item-header">
                      <h4 class="item-name" [ngClass]="item.definition.rarity | rarityName">
                        {{ item.definition.name }}
                      </h4>
                      @if (item.quantity > 1) {
                        <span class="item-quantity">x{{ item.quantity }}</span>
                      }
                    </div>

                    <!-- Quality/Trait badges -->
                    <app-item-modifiers [item]="item" displayMode="badge-level" size="normal"></app-item-modifiers>

                    <p class="sell-price">üí∞ {{ calculateSellPrice(item) }}g each (50% of value)</p>
                  </div>
                </div>
                <div class="item-actions">
                  <button class="button-secondary" (click)="sellItem(item.instanceId, 1)">
                    Sell 1
                  </button>
                  @if (item.quantity >= 5) {
                    <button class="button-secondary" (click)="sellItem(item.instanceId, 5)">
                      Sell 5
                    </button>
                  }
                  @if (item.quantity >= 10) {
                    <button class="button-secondary" (click)="sellItem(item.instanceId, 10)">
                      Sell 10
                    </button>
                  }
                  @if (item.quantity > 1) {
                    <button class="button-secondary" (click)="sellItem(item.instanceId, item.quantity)">
                      Sell All ({{ item.quantity }})
                    </button>
                  }
                </div>
              </div>
            }
          </div>
        }
      </div>
    }
  </div>
}
