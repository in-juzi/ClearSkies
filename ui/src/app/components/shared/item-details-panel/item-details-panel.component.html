<div class="item-details-panel"
     *ngIf="item"
     [ngStyle]="getPanelStyle()"
     (mousemove)="onDrag($event)"
     (mouseup)="onDragEnd()"
     (mouseleave)="onDragEnd()">
  <div class="details-header"
       (mousedown)="onDragStart($event)"
       [style.cursor]="isDragging ? 'grabbing' : 'grab'">
    <h3 [class]="inventoryService.getRarityColor(item.definition.rarity)">
      {{ item.definition.name }}
    </h3>
    <button (click)="onClose()" class="close-btn close-button">✕</button>
  </div>

  <div class="details-content">
    <!-- Item Icon and Description -->
    <div class="detail-icon-description-section">
      <div class="detail-icon-wrapper" *ngIf="item.definition.icon">
        <app-icon
          [icon]="item.definition.icon"
          [size]="80"
          [alt]="item.definition.name">
        </app-icon>
      </div>
      <p class="item-description">{{ item.definition.description }}</p>
    </div>

    <!-- Basic Info -->
    <div class="detail-section">
      <div class="detail-row">
        <span class="label">Category:</span>
        <span>{{ item.definition.category }}</span>
      </div>
      <div class="detail-row">
        <span class="label">Rarity:</span>
        <span [class]="inventoryService.getRarityColor(item.definition.rarity)">
          {{ item.definition.rarity }}
        </span>
      </div>
      <div class="detail-row">
        <span class="label">Quantity:</span>
        <span>{{ item.quantity }}</span>
      </div>
      <div class="detail-row">
        <span class="label">Weight:</span>
        <span>{{ item.definition.properties.weight.toFixed(1) }} kg</span>
      </div>
      <div class="detail-row">
        <span class="label">Value:</span>
        <span class="text-gold-400">{{ item.vendorPrice }}g each</span>
      </div>
    </div>

    <!-- Weapon Stats -->
    <div class="detail-section" *ngIf="item.definition.category === 'equipment' && item.definition.subcategories?.includes('weapon')">
      <h4 class="section-title">Weapon Stats</h4>
      <div class="weapon-stats-grid">
        <div class="detail-row" *ngIf="item.definition['slot']">
          <span class="label">Equipment Slot:</span>
          <span class="text-purple-400">{{ item.definition['slot'] }}</span>
        </div>
        <div class="detail-row" *ngIf="item.definition.properties['damageRoll']">
          <span class="label">Damage Roll:</span>
          <span class="text-red-400">{{ item.definition.properties['damageRoll'] }}</span>
        </div>
        <div class="detail-row" *ngIf="item.definition.properties['attackSpeed']">
          <span class="label">Attack Speed:</span>
          <span>{{ item.definition.properties['attackSpeed'].toFixed(1) }}s</span>
        </div>
        <div class="detail-row" *ngIf="item.definition.properties['critChance'] !== undefined">
          <span class="label">Crit Chance:</span>
          <span class="text-gold-400">{{ (item.definition.properties['critChance'] * 100).toFixed(1) }}%</span>
        </div>
        <div class="detail-row" *ngIf="item.definition.properties['skillScalar']">
          <span class="label">Skill:</span>
          <span class="text-purple-400">{{ item.definition.properties['skillScalar'] }}</span>
        </div>
        <div class="detail-row" *ngIf="item.definition.properties['requiredLevel'] !== undefined">
          <span class="label">Required Level:</span>
          <span class="text-blue-400">{{ item.definition.properties['requiredLevel'] }}</span>
        </div>
      </div>
    </div>

    <!-- Armor Stats -->
    <div class="detail-section" *ngIf="item.definition.category === 'equipment' && item.definition.subcategories?.includes('armor')">
      <h4 class="section-title">Armor Stats</h4>
      <div class="weapon-stats-grid">
        <div class="detail-row" *ngIf="item.definition['slot']">
          <span class="label">Equipment Slot:</span>
          <span class="text-purple-400">{{ item.definition['slot'] }}</span>
        </div>
        <div class="detail-row" *ngIf="item.definition.properties['armor'] !== undefined">
          <span class="label">Armor:</span>
          <span class="text-blue-400">{{ item.definition.properties['armor'] }}</span>
        </div>
        <div class="detail-row" *ngIf="item.definition.properties['evasion'] !== undefined">
          <span class="label">Evasion:</span>
          <span class="text-yellow-400">{{ item.definition.properties['evasion'] }}</span>
        </div>
        <div class="detail-row" *ngIf="item.definition.properties['blockChance'] !== undefined">
          <span class="label">Block Chance:</span>
          <span class="text-gold-400">{{ (item.definition.properties['blockChance'] * 100).toFixed(1) }}%</span>
        </div>
        <div class="detail-row" *ngIf="item.definition.properties['requiredLevel'] !== undefined">
          <span class="label">Required Level:</span>
          <span class="text-blue-400">{{ item.definition.properties['requiredLevel'] }}</span>
        </div>
      </div>
    </div>

    <!-- Scaled Weapon Stats (with player skill/attribute levels) -->
    <div class="detail-section" *ngIf="combatStats && item.definition.subcategories?.includes('weapon')">
      <h4 class="section-title">Scaled Combat Stats</h4>
      <div class="weapon-stats-grid" *ngIf="!loadingCombatStats">
        <div class="detail-row">
          <span class="label">Scaled Damage:</span>
          <span class="text-red-400">{{ combatStats.scaledDamageRoll }} → {{ combatStats.scaledDamageRange }} (avg {{ combatStats.avgScaledDamage }})</span>
        </div>
        <div class="detail-row">
          <span class="label">Attack Speed:</span>
          <span>{{ combatStats.attackSpeed.toFixed(1) }}s</span>
        </div>
        <div class="detail-row">
          <span class="label">Crit Chance:</span>
          <span class="text-gold-400">{{ (combatStats.critChance * 100).toFixed(1) }}%</span>
        </div>
        <div class="detail-row">
          <span class="label">Level Bonus:</span>
          <span class="text-green-400">+{{ combatStats.totalLevelBonus }} (Skill L{{ combatStats.skillLevel }} + Attr L{{ combatStats.attrLevel }})</span>
        </div>
      </div>
      <div *ngIf="loadingCombatStats" class="text-gray-400 text-center">
        Loading stats...
      </div>
    </div>

    <!-- Scaled Armor Stats -->
    <div class="detail-section" *ngIf="combatStats && item.definition.subcategories?.includes('armor')">
      <h4 class="section-title">Scaled Armor Stats</h4>
      <div class="weapon-stats-grid" *ngIf="!loadingCombatStats">
        <div class="detail-row" *ngIf="combatStats.armor !== undefined">
          <span class="label">Armor:</span>
          <span class="text-blue-400">{{ combatStats.armor }}</span>
        </div>
        <div class="detail-row" *ngIf="combatStats.evasion !== undefined">
          <span class="label">Evasion:</span>
          <span class="text-yellow-400">{{ combatStats.evasion }}</span>
        </div>
        <div class="detail-row" *ngIf="combatStats.blockChance !== undefined">
          <span class="label">Block Chance:</span>
          <span class="text-gold-400">{{ (combatStats.blockChance * 100).toFixed(1) }}%</span>
        </div>
        <div class="detail-row" *ngIf="combatStats.requiredLevel !== undefined">
          <span class="label">Required Level:</span>
          <span class="text-blue-400">{{ combatStats.requiredLevel }}</span>
        </div>
      </div>
      <div *ngIf="loadingCombatStats" class="text-gray-400 text-center">
        Loading stats...
      </div>
    </div>

    <!-- Subcategories -->
    <div class="detail-section" *ngIf="item.definition.subcategories && item.definition.subcategories.length > 0">
      <h4 class="section-title">Categories</h4>
      <div class="subcategories-list">
        <span class="subcategory-tag" *ngFor="let subcategory of item.definition.subcategories">
          {{ subcategory }}
        </span>
      </div>
    </div>

    <!-- Qualities -->
    <div class="detail-section" *ngIf="getQualityKeys(item.qualityDetails).length > 0">
      <h4 class="section-title">Qualities</h4>
      <div class="quality-list">
        <div *ngFor="let qualityId of getQualityKeys(item.qualityDetails)" class="quality-item">
          <div class="quality-header">
            <span class="quality-name">{{ item.qualityDetails[qualityId].name }}</span>
            <span [class]="inventoryService.getQualityColor(item.qualityDetails[qualityId].level)" class="quality-level-badge">
              Level {{ item.qualityDetails[qualityId].level }}
            </span>
          </div>
          <div class="quality-level-name" [class]="inventoryService.getQualityColor(item.qualityDetails[qualityId].level)">
            {{ item.qualityDetails[qualityId].levelData.name }}
          </div>
          <p class="quality-description">{{ item.qualityDetails[qualityId].levelData.description }}</p>

          <!-- Effects -->
          <div class="effects-section" *ngIf="item.qualityDetails[qualityId].levelData.effects">
            <div class="effect-label">Effects:</div>
            <div class="effects-grid">
              <div *ngFor="let effect of getQualityKeys(item.qualityDetails[qualityId].levelData.effects)" class="effect-item">
                <span class="effect-type">{{ formatEffectType(effect) }}:</span>
                <span class="effect-value">{{ formatEffectValue(item.qualityDetails[qualityId].levelData.effects[effect]) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Traits -->
    <div class="detail-section" *ngIf="getQualityKeys(item.traitDetails).length > 0">
      <h4 class="section-title">Traits</h4>
      <div class="trait-list">
        <div *ngFor="let traitId of getQualityKeys(item.traitDetails)" class="trait-item" [class]="'trait-rarity-' + item.traitDetails[traitId].rarity">
          <div class="trait-header">
            <span [class]="inventoryService.getRarityColor(item.traitDetails[traitId].rarity)" class="trait-name">
              {{ item.traitDetails[traitId].name }}
            </span>
            <div class="trait-badges">
              <span class="trait-rarity-badge" [class]="inventoryService.getRarityColor(item.traitDetails[traitId].rarity)">
                {{ item.traitDetails[traitId].rarity }}
              </span>
              <span [class]="inventoryService.getTraitLevelColor(item.traitDetails[traitId].level)" class="trait-level-badge">
                Level {{ item.traitDetails[traitId].level }}
              </span>
            </div>
          </div>
          <div class="trait-level-name" [class]="inventoryService.getRarityColor(item.traitDetails[traitId].rarity)">
            {{ item.traitDetails[traitId].levelData.name }}
          </div>
          <p class="trait-description">{{ item.traitDetails[traitId].levelData.description }}</p>

          <!-- Effects -->
          <div class="effects-section" *ngIf="item.traitDetails[traitId].levelData.effects">
            <div class="effect-label">Effects:</div>
            <div class="effects-grid">
              <div *ngFor="let effect of getQualityKeys(item.traitDetails[traitId].levelData.effects)" class="effect-item">
                <span class="effect-type">{{ formatEffectType(effect) }}:</span>
                <span class="effect-value">{{ formatEffectValue(item.traitDetails[traitId].levelData.effects[effect]) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Actions Footer (only show if enabled) -->
  <div class="details-footer" *ngIf="showActions">
    <!-- Quantity Controls (only show if enabled and quantity > 1) -->
    <div class="drop-quantity-controls" *ngIf="showDropControls && item.quantity > 1">
      <div class="quantity-header">
        <label class="quantity-label">Drop Quantity:</label>
        <div class="quantity-input-group">
          <input
            type="number"
            class="quantity-input"
            [(ngModel)]="dropQuantity"
            (ngModelChange)="updateDropQuantity($event)"
            [min]="1"
            [max]="getMaxDropQuantity()"
            [disabled]="!!item.equipped"
          />
          <span class="quantity-max">/ {{ item.quantity }}</span>
        </div>
      </div>
      <input
        type="range"
        class="quantity-slider"
        [(ngModel)]="dropQuantity"
        (ngModelChange)="updateDropQuantity($event)"
        [min]="1"
        [max]="getMaxDropQuantity()"
        [disabled]="!!item.equipped"
      />
    </div>

    <div class="detail-actions">
      <button
        class="btn-primary"
        *ngIf="item.definition.category === 'consumable'"
        (click)="onUse()"
        [disabled]="isUsingItem">
        {{ isUsingItem ? 'Using...' : 'Use' }}
      </button>
      <button
        class="btn-primary"
        *ngIf="item.definition.category === 'equipment' && !item.equipped"
        (click)="onEquip()">
        Equip
      </button>
      <button
        class="btn-secondary"
        *ngIf="item.definition.category === 'equipment' && item.equipped"
        (click)="onUnequip()">
        Unequip
      </button>
      <button
        class="btn-danger"
        *ngIf="showDropControls && item.quantity > 1"
        (click)="onRemove()"
        [disabled]="!!item.equipped">
        Drop ({{ dropQuantity }})
      </button>
      <button
        class="btn-danger"
        *ngIf="showDropControls"
        (click)="onRemoveAll()"
        [disabled]="!!item.equipped">
        Drop All
      </button>
    </div>
  </div>
</div>
